<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pong Oyunu</title>
<style>
    canvas {
        border: 1px solid black;
        display: block;
        margin: 0 auto;
    }
</style>
</head>
<body>
<canvas id="pongCanvas" width="800" height="400"></canvas>

<script>
    const canvas = document.getElementById("pongCanvas");
    const context = canvas.getContext("2d");
    const websocket = new WebSocket('ws://127.0.0.1:8000/ws/game/');

    // Oyun alanı boyutları
    const width = canvas.width;
    const height = canvas.height;

    // Oyuncuların ve topun başlangıç pozisyonları
    let player1 = { x: 20, y: height / 2 - 50, width: 10, height: 100, score: 0 };
    let player2 = { x: width - 30, y: height / 2 - 50, width: 10, height: 100, score: 0 };
    let ball = { x: width / 2, y: height / 2, radius: 10, speedX: 5, speedY: 5 };

    // Kontrol tuşları
    let keys = {};

    // Klavye kontrolü
    window.addEventListener("keydown", function (event) {
        // Oyun başladıysa herhangi bir tuşa basmayı işleme
        if (!gameStarted) {
            startGame(); // Oyunu başlat
            gameStarted = true; // Oyunun başladığını işaretle
        } else {
            // Oyun sırasında klavye kontrollerini işle
            keys[event.keyCode] = true;
        }
    });

    window.addEventListener("keyup", function (event) {
        delete keys[event.keyCode];
    });

    // WebSocket bağlantısı
    websocket.onopen = function () {
        console.log('WebSocket bağlantsı başarıyla kuruldu. Oyun başlatılmak üzere.');
    };

    websocket.onmessage = function (event) {
        const data = JSON.parse(event.data);
        player1.y = data.player1.y;
        player2.y = data.player2.y;
        ball.x = data.ball.x;
        ball.y = data.ball.y;
        player1.score = data.player1.score;
        player2.score = data.player2.score;

        draw();
    };

    websocket.onerror = function (error) {
        console.error('WebSocket hatası:', error);
    };

    function sendGameDataToServer() {
        const gameData = {
            player1: { y: player1.y, score: player1.score },
            player2: { y: player2.y, score: player2.score },
            ball: { x: ball.x, y: ball.y },
        };
        websocket.send(JSON.stringify(gameData));
    }

    // Oyunu başlat
    let gameStarted = false; // Oyunun başlayıp başlamadığını kontrol etmek için bir değişken
    function startGame() {
        gameLoop(); // Oyun döngüsünü başlat
    }

    // Oyuncu hareketi
    function movePlayers() {
        if (keys[38] && player2.y > 0) {
            player2.y -= 5;
        }
        if (keys[40] && player2.y < height - player2.height) {
            player2.y += 5;
        }
        if (keys[87] && player1.y > 0) {
            player1.y -= 5;
        }
        if (keys[83] && player1.y < height - player1.height) {
            player1.y += 5;
        }
    }

    // Topun hareketi
    function moveBall() {
        ball.x += ball.speedX;
        ball.y += ball.speedY;

        // Topun sınırlara çarpma kontrolü
        if (ball.y + ball.radius > height || ball.y - ball.radius < 0) {
            ball.speedY = -ball.speedY;
        }

        // Oyuncu 1 ile çarpışma kontrolü
        if (ball.x - ball.radius < player1.x + player1.width &&
            ball.y > player1.y &&
            ball.y < player1.y + player1.height) {
            ball.speedX = -ball.speedX;
        }

        // Oyuncu 2 ile çarpışma kontrolü
        if (ball.x + ball.radius > player2.x &&
            ball.y > player2.y &&
            ball.y < player2.y + player2.height) {
            ball.speedX = -ball.speedX;
        }

        // Topun gol olma kontrolü
        if (ball.x - ball.radius < 0) {
            player2.score++;
            resetBall();
        } else if (ball.x + ball.radius > width) {
            player1.score++;
            resetBall();
        }
    }

    // Topun başlangıç pozisyonuna dönmesi
    function resetBall() {
        ball.x = width / 2;
        ball.y = height / 2;
        ball.speedX = -ball.speedX;
    }

    // Oyun alanını temizleme
    function clear() {
        context.clearRect(0, 0, width, height);
    }

    // Oyuncu ve topu çizme
    function draw() {
        clear();
        context.fillStyle = "#000";
        context.fillRect(player1.x, player1.y, player1.width, player1.height);
        context.fillRect(player2.x, player2.y, player2.width, player2.height);

        context.beginPath();
        context.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
        context.fillStyle = "#000";
        context.fill();

        context.font = "30px Arial";
        context.fillText(player1.score, width / 4, 50);
        context.fillText(player2.score, (3 * width) / 4, 50);
    }

    // Oyunun mekaniklerini güncelleyen fonksiyon
    function updateGame() {
        movePlayers();
        moveBall();
        sendGameDataToServer();
    }

    // Oyun döngüsü (loop)
    function gameLoop() {
        updateGame();
        requestAnimationFrame(gameLoop);
    }

    // Oyunu başlat
    startGame();

</script>
</body>
</html>
