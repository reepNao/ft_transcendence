name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: centos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      
    - name: Install Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.x'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: SSH into server and deploy services
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        password: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          cd /path/to/apigateway
          python3 manage.py runserver

          cd /path/to/authservice
          python3 manage.py runserver 8001

          cd /path/to/coregameservice
          python3 manage.py runserver 8005

          cd /path/to/friends
          python3 manage.py runserver 8002

          cd /path/to/mailservice
          python3 manage.py runserver 8006

          cd /path/to/matchmaking
          python3 manage.py runserver 8007

          cd /path/to/usermanagement
          python3 manage.py runserver 8004
